# 开发日志与风险管理 (Development Log & Risk Management)

## 1. 阶段一开发日志 (Phase 1 Log: 12/28)

### 1.1 进度更新

**记录时间**：2025/12/28  
**当前进度**：0% → 20% (架构确立)

### 1.2 技术决策 (Architectural Decisions)

#### 1.2.1 架构融合

**决策**：决定将 UniFocus 的"采集-评分"逻辑转化为"手势采样-碰撞判定"

**理由**：
- 手势识别更适合 3D 交互场景
- 碰撞检测比评分系统更直观
- 降低系统复杂度，提高响应速度

#### 1.2.2 渲染策略

**决策**：弃用复杂 PBR，采用 StandardMaterial + 自发光纹理，降低 GPU 压力

**理由**：
- MVP 阶段优先保证性能和稳定性
- 自发光效果可以模拟发光经络，用视觉错觉代替高模精度
- 简化材质方案可以加快开发速度

**实现细节**：
- 统一采用 `StandardMaterial` 的 `emissive` 属性
- 通过 `emissiveIntensity` 控制发光强度
- 配合 UnrealBloomPass 实现辉光效果

#### 1.2.3 部署方案

**决策**：使用 Live Server 解决模型加载的跨域限制

**理由**：
- 弃用本地 Server，降低环境配置成本
- 决定使用 CDN 引入所有库，确保"双击即运行"
- VS Code Live Server 插件作为统一开发环境，简单易用

#### 1.2.4 交互策略

**决策**：确定"先旋转、后剥离"的交互优先级

**实现方式**：
- **手势位移控制旋转**：通过手部 X 坐标控制心脏模型的 Y 轴旋转
  - 公式：$TargetRotation = (HandX - 0.5) \cdot \pi \cdot Sensitivity$
  - **重要约束**：当 `isPinching` 为 `true` 时，暂时锁定旋转（或大幅降低旋转灵敏度至 10%），确保用户能稳定选中解剖部位
- **手势形态控制剥离**：
  - **OPEN（张开手）状态**：触发剥离动画，`animateExplode(factor)` 从 0 过渡到 1
  - **FIST（握拳）状态**：触发复位动画，`animateExplode(factor)` 从当前值过渡到 0
  - **设计理由**：张开手更符合"展开"的直觉，握拳更符合"收回"的直觉

### 1.3 阻塞点 (Blockers)

#### 1.3.1 跨域模型加载

**问题**：浏览器限制本地模型文件加载，直接打开 HTML 文件无法加载 GLB 模型

**解决方案**：
- 组员 C 已确认使用 VS Code Live Server 插件作为统一开发环境
- 所有开发人员统一使用该插件启动本地服务器
- 后续考虑使用 CDN 托管模型文件（如果文件大小允许）

### 1.4 明日目标 (Next Steps)

**优先级说明**：Live Server 必须在 Day 1 跑通，否则模型无法加载，全员停工。

- [ ] **P0 - 验证 Live Server 环境下的模型加载**（阻塞性任务，必须首先完成）
- [ ] 完成 MediaPipe 与 Three.js 的坐标系初步对齐（坐标原点重合）
- [ ] 实现基础的手势识别功能（至少 PINCH、OPEN、FIST 三种状态）
- [ ] 加载心脏 GLB 模型并显示在场景中

---

## 2. 决策复盘与弥补方案 (Decision Review & Mitigation)

### 2.1 模型精度弥补

#### 2.1.1 问题描述

由于 MVP 采集的模型细节有限，模型可能缺乏足够的视觉细节和体积感。

#### 2.1.2 弥补方案

**决策**：在 fragmentShader 中叠加一层菲涅尔反射（Fresnel Effect），用视觉边缘高光来增强模型体积感

**实现方式**：
- **技术路径**：修改 `StandardMaterial` 的 `onBeforeCompile` 钩子来注入菲涅尔逻辑
- **实现细节**：
  - 保留 StandardMaterial 的 `emissive` 和 `emissiveIntensity` 属性（用于自发光）
  - 在 `onBeforeCompile` 中修改 fragmentShader，注入菲涅尔反射计算
  - 计算视角与表面法线的夹角（Fresnel 系数）
  - 在边缘区域增加高光强度
  - 配合 UnrealBloomPass 实现边缘发光效果
- **优势**：既保留了内置材质的自发光（Emissive）简便性，又实现了边缘高光效果

**预期效果**：
- 增强模型的立体感和层次感
- 弥补模型精度不足的视觉缺陷
- 提升整体视觉效果

### 2.2 性能优化决策

#### 2.2.1 材质简化

**决策回顾**：已决定使用 StandardMaterial 替代 PBR

**补充说明**：
- 所有零件统一使用相同的材质配置
- 通过 `emissive` 和 `emissiveIntensity` 实现发光效果
- 避免复杂的纹理贴图和法线贴图

#### 2.2.2 渲染优化

**决策**：根据设备性能动态调整渲染质量

**实现策略**：
- 实时监控 FPS
- 当 FPS < 20 时，自动降低渲染质量
- 降低 BloomPass 分辨率或关闭抗锯齿
- 减少同时渲染的粒子数量

---

## 3. 风险预案 (Risk Mitigation Plans)

### 3.1 光照影响识别 - 详细应对方案

**风险等级**：高

**问题描述**：环境光线不足或过强会影响 MediaPipe 的手部识别准确度

**解决方案**：
1. **UI 引导**：在页面加载时显示提示："请将手部置于充足光源下"
2. **实时检测**：监控识别置信度，当置信度低于阈值时显示警告
3. **亮度补偿**：在图像预处理阶段增加亮度调整算法

### 3.2 DeepMed 响应延迟 - 详细应对方案

**风险等级**：中

**问题描述**：API 调用可能存在网络延迟，影响用户体验

**解决方案**：
1. **本地缓存**：建立 `LocalCache` 对象，存储核心零件的预置简介
2. **预置内容**：为每个解剖部位准备 30 字左右的简介，实现即时显示
3. **异步加载**：先显示缓存内容，后台异步获取完整 API 响应后更新

**实现细节**：
- 组员 C 负责实现本地缓存（LocalCache）机制
- 预置核心零件的 30 字简介
- 先显示缓存内容，后台异步获取完整 API 响应后更新

### 3.3 手机/低端机掉帧 - 详细应对方案

**风险等级**：低

**问题描述**：低端设备可能无法流畅运行复杂的渲染效果

**解决方案**：
1. **性能检测**：实时监控 FPS，当 FPS < 20 时触发降级策略
2. **效果降级**：自动降低 BloomPass 分辨率或关闭抗锯齿
3. **自适应渲染**：根据设备性能动态调整渲染质量

### 3.4 交互降级方案

#### 3.4.1 问题描述

部分用户设备可能不支持摄像头，或用户环境光线不足导致手势识别失败。

#### 3.4.2 降级方案

**决策**：若用户设备不支持摄像头，自动开启"鼠标滚轮剥离"作为备选交互模式

**实现方式**：
1. **设备检测**：
   - 页面加载时检测 `navigator.mediaDevices.getUserMedia` 是否可用
   - 检测摄像头权限状态

2. **降级交互**：
   - **鼠标控制旋转**：鼠标移动控制心脏模型的旋转
   - **滚轮控制剥离**：鼠标滚轮控制 `animateExplode(factor)` 的 factor 值
   - **点击触发检测**：鼠标点击触发 Raycaster 检测，替代手势 PINCH

3. **UI 提示**：
   - 检测到无摄像头时，显示提示："使用鼠标和滚轮进行交互"
   - 在页面底部显示操作说明

**优势**：
- 确保所有用户都能使用系统
- 提供一致的交互体验
- 降低技术门槛

**实现责任**：组员 C 负责实现交互降级方案代码

---

## 4. 后续开发计划

### 4.1 阶段二预期目标 (12/30 - 01/02)

- [ ] 完成手势识别与坐标转换的联调
- [ ] 实现心脏模型的加载和基础渲染
- [ ] 完成 `animateExplode` 动画函数
- [ ] 实现基础的 Raycaster 碰撞检测

### 4.2 阶段三预期目标 (01/03 - 01/06)

- [ ] 集成 DeepMed API
- [ ] 完成 UI 纠错反馈系统
- [ ] 实现本地缓存机制
- [ ] 进行端到端测试和优化
- [ ] 录制演示视频
- [ ] 整理项目文档

### 4.3 潜在改进方向

1. **性能优化**：
   - 实现模型 LOD（细节层次）系统
   - 优化动画插值算法
   - 减少不必要的重渲染

2. **交互增强**：
   - 添加手势识别更多状态（如指向、抓取等）
   - 实现多手势组合操作
   - 添加触觉反馈（如果设备支持）

3. **视觉效果**：
   - 实现更复杂的材质效果
   - 添加粒子特效
   - 实现动态光照

4. **功能扩展**：
   - 支持多个心脏模型切换
   - 实现解剖步骤引导
   - 添加学习进度跟踪
